---
- hosts: localhost
  gather_facts: no
  #strategy: free

  vars_files:
    - colorschemes.yml

  vars:
    become: false
    colorscheme: "{{ colorscheme_brin }}"
    ci: "{{ lookup('env', 'CI') | bool }}" # are we running in Travis?
    username: "{% if ci %}travis{% else %}siddharthist{% endif %}"
    home: "{% if ci  %}{{ playbook_dir }}{% else %}{{ lookup('env', 'HOME') }}{% endif %}"
    xdg_config_home: "{% if ci %}{{ playbook_dir }}{% else %}{{ lookup('env', 'XDG_CONFIG_HOME') }}{% endif %}"
    symlinks:
      - src: beets.yml
        dst: "{{ xdg_config_home }}/beets/config.yaml"
      - src: gtkrc-2.0
        dst: "{{ home }}/.gtkrc-2.0"
      - src: gtkrc-3.0.ini
        dst: "{{ xdg_config_home }}/gtk-3.0/settings.ini"
      - src: conkyrc
        dst: "{{ xdg_config_home }}/conky/conkyrc"
      - src: compton.conf
        dst: "{{ xdg_config_home }}/compton.conf"
      - src: gitconfig
        dst: "{{ home }}/.gitconfig"
      - src: gitignore
        dst: "{{ xdg_config_home }}/gitignore"
      - src: i3
        dst: "{{ xdg_config_home }}/i3/config"
      - src: library.blb
        dst: "{{ xdg_config_home }}/beets/library.blb"
      - src: latexmkrc
        dst: "{{ home }}/.latexmkrc"
      - src: latex-mode-snippets
        dst: "{{ home }}/.emacs.d/private/snippets/latex-mode"
      - src: nix-channels
        dst: "{{ home }}/.nix-channels"
      - src: pre-commit
        dst: "{{ home }}/.config/git/hooks/pre-commit"
      - src: spacemacs
        dst: "{{ home }}/.spacemacs"
      - src: sxhkdrc
        dst: "{{ xdg_config_home }}/sxhkd/sxhkdrc"
      - src: xinitrc
        dst: "{{ home }}/.xinitrc"

  tasks:
    - name: configure nixos
      become: yes
      register: nixos
      file:
        follow: true
        state: link
        src: "{{ playbook_dir }}/nixos"
        path: /etc/nixos
        owner: "{{ username }}"
        group: "{{ username }}"
        mode: 0660
      when: "{{ (become | bool) and (not ci) }}"

    - name: make user symlink dirs
      file:
        follow: true
        state: directory
        path: "{{ item.dst | dirname }}"
        owner: "{{ item.owner | default(username) }}"
        group: "{{ item.group | default(username) }}"
        mode: "{{ item.mode | default('0775') }}"
      with_items: "{{ symlinks }}"

    - name: make user symlinks
      file:
        follow: true
        state: link
        src: "{{ playbook_dir }}/files/{{ item.src }}"
        path: "{{ item.dst }}"
        owner: "{{ item.owner | default(username) }}"
        group: "{{ item.group | default(username) }}"
        mode: "{{ item.mode | default('0664') }}"
      with_items: "{{ symlinks }}"

    - name: render user templates
      template:
        src: "{{ playbook_dir }}/templates/{{ item.src }}.j2"
        dest: "{{ item.dst }}"
        owner: "{{ item.owner | default(username) }}"
        group: "{{ item.group | default(username) }}"
        mode: "{{ item.mode | default('0664') }}"
      with_items:
        - src: Xresources
          dst: "{{ home }}/.Xresources"

    - name: handle xrdb changes
      command: xrdb -merge $HOME/.Xresources
      when: "{{ not ci }}"
